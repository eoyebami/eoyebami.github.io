<h1>Istio Traffic Management</h1>
* Now that we have all of our istio components installed, we'll go over how we can route our end users through our service mesh to access our services

<h2>Istio Gateways</h2>
* `Istio Gateways` are loadbalancers that sit at the each of the mesh, that manage both inbound and outbound traffic to your services
 - They function pretty similarly to how ingress works in kubernetes
 - You can route traffic to specific services based on rules defined in ingress
 - `Gateways` function in the same way, although `istio` has a lot more features
* When `istio` is deployed into the system, 2 components may run in that `istio-system` namespace depending on how you configured `istio`
  - They are known as `Istio Gateway Controllers`:
    * `istio-ingressgateway`: manages all inbound traffic to your services
    * `istio-egressgateeway`: manages all outfound traffic from your services
  - These controllers are simply standalone envoy proxies, the same which run as sidecars in our microservices pods
* You can create a gateway and configure how it should manage traffic at the hosts you specified
  - A gateway would need to be defined for both egress and ingress traffic

<h2>Istio Gateways: Configurations</h2>
* In the specifications of an `Istio Gateway` there are a few components to take note of
* `selector`: labels that indicate a set of pod to which this gateway will be applied

<h4>Server Specifications</h4>
* `server`: a list of server specifications
  - `name`: name of server being defined
  - `port` port where proxy should listen to incoming connections
    * `number`: port number
    * `name`: label assigned to port
    * `protocol`: protocol exposed on port `HTTPS|HTTPS|GRPC|GRPC-WEB|HTTP2|MONGO|TCP|TLS`
  - `hosts`: hosts exposed by this gateway
    * You can set namespace prefixes for `Virtual Service` discovery by using `/`
    * `./example.com`: selects for matching vs in the current namespace
    * `*/example.com`: selects for matching vs in all namspaces
    * `jenkins/example.com`: selects for matching vs in jenkins namespace
    * `*.example.com`: wildcards can be used, but all matches for vs with subdomains which the specified domain
    * More info [here](https://istio.io/latest/docs/reference/config/networking/gateway/#Server)
  - `tls`: tls related configurations for server
    * More info [here](https://istio.io/latest/docs/reference/config/networking/gateway/#Server)
    * `httpsRedirect`: if defined, will redirect all HTTP connections to HTTPS
    * `serverCerticate, caCertificates, privateKey`: required if mode is SIMPLE or MUTUAL, path must be specified and mounted in controller pods
    * `credentialName`: specify name of credential holding cert secrets under name `tls.key, tls.crt || key, cert`
    * `minProtocolVersion`: min TLS [Version](https://istio.io/latest/docs/reference/config/networking/gateway/#ServerTLSSettings-TLSProtocol)
    * `maxProtocolVersion`: max TLS [Version](https://istio.io/latest/docs/reference/config/networking/gateway/#ServerTLSSettings-TLSProtocol)
    * `mode`: tls modes to enforce on the proxy
 
      ```
      - PASSTHROUGH: TLS termination will not occur, sni string presented by client will be match on `Virtual Service` TLS route
      - SIMPLE: standard TLS
      - MUTAL: mTLS
      - AUTO_PASSTHROUGH: similar passthrough but does not require an additional vs to be configured in the upstream
      - ISTIO_MUTUAL: using mTLS with certs generated by istio
      - OPTIONAL_MUTUAL: similar to mutual mode but client cert is optional
      ```

  ```yml
  apiVersion: networking.istio.io/v1alpha3
  kind: Gateway
  metadata:
    name: istio-ingressgateway
  spec:
    selector: # select for the ingress gateway controller you want to balance traffic through
      istio: ingressgateway # default label set for all ingressgateways
    servers:
    - port: # any traffic coming in from the host at this port will be directed to the selected ingressgateway 
        number: 80
        name: http
        protocol: HTTP
      hosts: # multiple hosts can be specified
      - "dataengine.com"
      tls:
        httpsRedirect: true # any traffic coming in at port HTTP will be redirected to HTTPS
    - port: # enable HTTPS
        number: 443
        name: https
        protocol: HTTPS
      hosts:
      - "dataengine.com"
      tls: # this is where we apply the cert for HTTPS for the LB of our service mesh
        mode: SIMPLE
        minProtocolVersion: TLSV1_2 # default minVersion
        maxProtocolVersion: TLSV1_3
        credentialName: cert for gateway loadbalancer
  ---
  apiVersion: networking.istio.io/v1alpha3
  kind: Gateway
  metadata:
    name: istio-egressgateway
  spec:
    selector: # select for the ingress gateway controller you want to balance traffic through
      istio: egressgateway # default label set for all egressgateways
    servers:
    - port: # enable HTTPS
        number: 443
        name: 
        protocol: 
      hosts:
      - "dataengine.com"
      tls: 
        mode: SIMPLE
        minProtocolVersion: TLSV1_2 # default minVersion
        maxProtocolVersion: TLSV1_3
        credentialName: cert for gateway loadbalancer
  ```

